plugins {
    id "com.avast.gradle.docker-compose" version "0.14.3"
    id "com.diffplug.spotless" version "5.8.2"
    id "org.sonarqube" version "3.2.0"
    id "jacoco"
}

apply plugin: 'application'
apply plugin: 'idea'
apply plugin: 'com.avast.gradle.docker-compose'

group 'cricket.merstham'

ext {
    dependencyVersions = [
            spring_boot    : "2.7.5",
            spring_sessions: "2.6.3",
            apollo         : "2.5.11",
            prometheus     : "1.8.5",
            lombok         : "1.18.24",
            testcontainers : "1.16.2",
            jackson        : "2.13.2",
    ]
}

dockerCompose {
    buildBeforeUp = true
    forceRecreate = true
    startedServices = [
            'loki',
            'traefik',
            'postgres',
            'redis',
            'keycloak',
            'graph',
            'smtp',
            'prometheus',
            'web',
    ]

    def logDir = new File(project.buildDir, "logs")
    if (!logDir.exists()) {
        println("Creating logs folder...")
        logDir.mkdir()
    }
    captureContainersOutput = false
    captureContainersOutputToFile = new File('logs', 'docker-compose-gradle.log')
    projectName = "website"
}

spotless {
    java {
        target '**/*.java'
        googleJavaFormat('1.9').aosp()
        importOrder '', 'javax', 'java', '\\#'
    }

    sql {
        target 'sql/**/*.sql'

        dbeaver()
    }

    groovyGradle {
        target '**/*.gradle'
    }
}

repositories {
    mavenCentral()
}

sonarqube {
    properties {
        property "sonar.projectKey", "mersthamcc_website"
        property "sonar.organization", "mersthamcc"
        property "sonar.host.url", "https://sonarcloud.io"
    }
}

jacocoTestReport {
    reports {
        xml.enabled true
    }
    dependsOn "test"
}

tasks["sonarqube"].dependsOn test